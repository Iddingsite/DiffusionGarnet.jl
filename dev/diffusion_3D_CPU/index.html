<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl</title><meta name="title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="og:title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="twitter:title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta name="description" content="Documentation for DiffusionGarnet.jl."/><meta property="og:description" content="Documentation for DiffusionGarnet.jl."/><meta property="twitter:description" content="Documentation for DiffusionGarnet.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="DiffusionGarnet.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">DiffusionGarnet.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../background/">Background</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../diffusion_1D/">Diffusion in 1D Cartesian coordinates</a></li><li><a class="tocitem" href="../diffusion_spherical/">Diffusion in spherical coordinates</a></li><li><a class="tocitem" href="../comparing_diffcoef/">Using different diffusion coefficient datasets</a></li><li><a class="tocitem" href="../diffusion_2D/">Diffusion in 2D Cartesian coordinates on CPU</a></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Callbacks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../updating_PT/">Updating pressure and temperature conditions</a></li><li><a class="tocitem" href="../saving_output/">Saving output as HDF5 files</a></li></ul></li><li class="is-active"><a class="tocitem" href>Diffusion in 3D Cartesian coordinates on CPU</a></li><li><a class="tocitem" href="../diffusion_3D_GPU/">Diffusion in 3D Cartesian coordinates on GPU</a></li></ul></li><li><a class="tocitem" href="../reference/">List of functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Diffusion in 3D Cartesian coordinates on CPU</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Diffusion in 3D Cartesian coordinates on CPU</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl/blob/main/docs/src/diffusion_3D_CPU.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="3D_diffusion_CPU"><a class="docs-heading-anchor" href="#3D_diffusion_CPU">Diffusion in 3D Cartesian coordinates on CPU and GPU</a><a id="3D_diffusion_CPU-1"></a><a class="docs-heading-anchor-permalink" href="#3D_diffusion_CPU" title="Permalink"></a></h1><div class="admonition is-info" id="Note-cd6f1423435276fb"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-cd6f1423435276fb" title="Permalink"></a></header><div class="admonition-body"><p>This tutorial is combining the knowledge acquired from the <a href="../diffusion_2D/#2D_diffusion_CPU">2D modelling</a> and the <a href="../saving_output/#saving_output">Saving output as HDF5 files</a> tutorials. Make sure to understand them before starting this one.</p></div></div><p>The 3D geometry of garnets can be obtained from micro-computed tomography (µCT) scans or other similar techniques. Combined with an initial composition, the full grain can be modelled with realistic geometry.</p><p>In this tutorial, we will reproduce the results from the publication &quot;Simulating major element diffusion in garnet using realistic 3D geometries&quot; by Dominguez et al. (in review).</p><p>To do so, we will use a callback function to save the results of the simulation to disk at regular intervals to be able to visualise the results using the software <a href="https://www.paraview.org/">ParaView</a>.</p><p>As mentioned in the tutorial for <a href="../diffusion_2D/#2D_diffusion_CPU">2D modelling</a> DiffusionGarnet internally uses the package <a href="https://github.com/omlins/ParallelStencil.jl">ParallelStencil.jl</a>. Make sure to start with multiple threads to get the most out of this approach if you run the model on CPU.</p><p>For this tutorial, we will first download the data from this <a href="https://zenodo.org/records/15045718">Zenodo repository</a> and then load it into our simulation. The data is using the 3D geometry of a real garnet grain, derived from µCT, with the initial composition of the major elements (Mg, Fe, Mn, and Ca) and the location of the boundary of the garnet domain with the matrix domain.</p><pre><code class="language-julia hljs">using Downloads
using JLD2
using DiffusionGarnet

# define the current directory as the working directory
cd(@__DIR__)

# Define the Zenodo dataset URL, you can change the name to download other datasets in the Zenodo repository (https://zenodo.org/records/15045718)
# here, we will download the lowest resolution dataset (256³) to save time, for the model isolated matrix model (IMM). Higher resolutions (512^3 and 768^3) are also available in the repository. See publication for more details.
data_file = &quot;256_cubed_IMM_compo.jld2&quot;

# check if the file is already downloaded
if !isfile(data_file)
    # Define the Zenodo dataset URL, you can change the name to download other datasets in the Zenodo repository.
    zenodo_url = &quot;https://zenodo.org/records/15045718/files/&quot; * data_file * &quot;?download=1&quot;

    # Download the file in the same folder as this file (this can take a while if you connection is slow)
    Downloads.download(zenodo_url, data_file)
end

# use JLD2
file = jldopen(data_file, &quot;r&quot;)
@unpack Mg0, Fe0, Mn0, Ca0, grt_boundary = file
close(file)</code></pre><p>We will use the dimensions of the real garnet grain from the µCT scan of the publication to define the domain of the simulation.</p><pre><code class="language-julia hljs"># define total length in x and y of the real scan domain
Lx = 11422.61u&quot;µm&quot;
Ly = 11422.61u&quot;µm&quot;
Lz = 7623.57u&quot;µm&quot;
# define total time for the model
tfinal = 10.0u&quot;Myr&quot;
# define the pressure and temperature conditions
T = 700u&quot;°C&quot;
P = 0.8u&quot;GPa&quot;

# composition at the contact between garnet and matrix
Mg_border = 0.1152
Fe_border = 0.6012
Mn_border = 0.0435
Ca_border = 0.2401

# add this to fix the composition on the boundary
Mg0[grt_boundary .== 1] .= Mg_border
Fe0[grt_boundary .== 1] .= Fe_border
Mn0[grt_boundary .== 1] .= Mn_border
Ca0[grt_boundary .== 1] .= Ca_border

# convert to float32 to save memory
Mg0 = convert(Array{Float32}, Mg0)
Fe0 = convert(Array{Float32}, Fe0)
Mn0 = convert(Array{Float32}, Mn0)
Ca0 = convert(Array{Float32}, Ca0)
grt_boundary = convert(Array{Float32}, grt_boundary)

IC3D = IC3DMajor(;CMg0=Mg0, CFe0=Fe0, CMn0=Mn0, Lx, Ly, Lz, tfinal, grt_boundary)
domain3D = Domain(IC3D, T, P)

# free memory, as 3D data is large
file = nothing
data = nothing
Mg0 = nothing
Fe0 = nothing
Mn0 = nothing
Ca0 = nothing
grt_boundary = nothing
IC3D = nothing</code></pre><div class="admonition is-info" id="Note-badc5ed90629d75"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-badc5ed90629d75" title="Permalink"></a></header><div class="admonition-body"><p>Only the boundary between the garnet and the matrix is defined specifically in the data. Concerning the contact between garnet and inclusions, it is defined as a homogeneous boundary condition by default, meaning that no flux is exchanged between the garnet and the inclusions.</p></div></div><p>Now, let&#39;s define a callback function to save the results of the simulation in a HDF5 file, similar to the tutorial <a href="../saving_output/#saving_output">Saving output as HDF5 files</a>:</p><pre><code class="language-julia hljs">time_save_first = collect(range(0, 1, step=0.1))u&quot;Myr&quot;
time_save_second = collect(range(1.5, 10, step=0.5))u&quot;Myr&quot;
time_save = vcat(time_save_first,time_save_second)

@unpack t_charact = domain3D  # unpack characteristic time to nondimensionalise the time for the simulation
time_save_ad = ustrip.(u&quot;Myr&quot;, time_save) ./ t_charact  # convert to Myr, remove units, and convert to nondimensional time

# create the callback function
save_data_callback = PresetTimeCallback(time_save_ad, save_data_paraview, save_positions=(false,false))

path_save = &quot;data_model_10_Ma.h5&quot;  # choose the name and the path of the HDF5 output file (make sure to add .h5 or .hdf5 at the end)</code></pre><div class="admonition is-info" id="Note-ecfded420a89412c"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-ecfded420a89412c" title="Permalink"></a></header><div class="admonition-body"><p>We used here <code>save_data_paraview()</code> instead of <code>save_data()</code> to save the data in a format that can be read by ParaView.</p></div></div><p>We can now use the function <code>simulate()</code> to solve our system:</p><pre><code class="language-julia hljs"># solve the problem using DifferentialEquations.jl
sol = simulate(domain3D; callback=save_data_callback, path_save=path_save, save_everystep=false,  save_start=false, progress=true, progress_steps=1, solver=ROCK2());</code></pre><div class="admonition is-info" id="Note-386d4bcb63d34715"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-386d4bcb63d34715" title="Permalink"></a></header><div class="admonition-body"><p>The calculation can take some time depending on your machine, it is a low resolution model, but it is still a 3D simulation. The progress bar will give you an idea of the progress of the simulation.</p></div></div><p>Two files should have been created in the same folder as your current session at the end of the simulation: <code>data_model_10_Ma.h5</code> and <code>data_model_10_Ma.xdmf</code>. The first one is the HDF5 file containing the results of the simulation, and the second one is an XDMF file describing the HDF5 file. This last file can be opened with visualisation software programs, such as <a href="https://www.paraview.org/">Paraview</a>.</p><div class="admonition is-warning" id="Warning-641c804ef1e54d4d"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-641c804ef1e54d4d" title="Permalink"></a></header><div class="admonition-body"><p>For any visualisation software, make sure you open the XDMF file and not the HDF5 file. For <a href="https://www.paraview.org/">ParaView</a>, select the <code>XDMF Reader</code> as the reader when you open your data. Only Paraview has been tested with this package, but other software should work as well.</p></div></div><p>Here is a video obtained from the results of Fe for the high resolution model (768³) using ParaView:</p><p><img src="../assets/img/Fe_3D.gif" alt="2D diffusion of a garnet"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../saving_output/">« Saving output as HDF5 files</a><a class="docs-footer-nextpage" href="../diffusion_3D_GPU/">Diffusion in 3D Cartesian coordinates on GPU »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Friday 8 August 2025 23:44">Friday 8 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
