var documenterSearchIndex = {"docs":
[{"location":"diffusion_2D/#2D_diffusion_CPU","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"","category":"section"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"From chemical maps (e.g. obtained by microprobe or SEM), we can acquire 2D composition of garnet. Assuming an initial composition, we can diffuse this garnet grain.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"When dealing with 2D or 3D data, the question of performance comes into play. It is important to write performant code that scales well. To help us with this, DiffusionGarnet internally uses the package ParallelStencil.jl, which allows to write high-level code for parallel high-performance stencil computation on both GPUs and CPUs. We will focus on CPUs in this tutorial, as they are easier to set up, but significant performance gains can be expected on GPUs.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"To get the most out of this approach, it is important to start Julia with multiple threads as multithreading is the approach used to parallelise the code. See the official Julia documentation for more information.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"To achieve this, the simpler is to start Julia with:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"$ julia --threads auto","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"which should select the maximum number of threads available on your machine.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"The check that, we can use:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"julia> println(\"Number of threads: $(Base.Threads.nthreads())\")\n16","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"which output the current number of threads used in the Julia session (here 16).","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"tip: Tip\nThe degree of parallelisation that can be achieved increases with the number of threads available.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"For this tutorial, we will use example data from the 2D examples section, which contain four composition matrices, and the contour of the garnet grain.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"First, we load the data, which should be in the same folder as your current session:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"using DiffusionGarnet  # this can take a while\nusing DelimitedFiles\nusing Plots\nusing ProgressBars\n\nprintln(\"Number of threads: $(Threads.nthreads())\")\n\n# load the data of your choice\n# (here from the text files located in https://github.com/Iddingsite/DiffusionGarnet.jl/tree/main/examples/2D,\n# place it in the same folder as where you are running the code)\n\nMg0 = DelimitedFiles.readdlm(\"Xprp.txt\", '\\t', '\\n', header=false)\nFe0 = DelimitedFiles.readdlm(\"Xalm.txt\", '\\t', '\\n', header=false)\nMn0 = DelimitedFiles.readdlm(\"Xsps.txt\", '\\t', '\\n', header=false)\nCa0 = DelimitedFiles.readdlm(\"Xgrs.txt\", '\\t', '\\n', header=false)\ngrt_boundary = DelimitedFiles.readdlm(\"contour_Grt.txt\", '\\t', '\\n', header=false)\n\n# define total length in x and y\nLx = 9000.0u\"µm\"\nLy = 9000.0u\"µm\"\n# define total time for the model\ntfinal = 1.0u\"Myr\"\n# define the pressure and temperature conditions\nT = 900u\"°C\"\nP = 0.6u\"GPa\"","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"Plotting the initial data:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"distance = LinRange(0, ustrip(u\"µm\", Lx), size(Mg0,1))\n\nl = @layout [a b ; c d ]\n\np1 = heatmap(distance, distance, Mg0, label=\"Mg\", dpi=200, title=\"Mg\", clim=(0, maximum(Mg0)), ylabel= \"Distance (µm)\")\np2 = heatmap(distance, distance, Fe0, label=\"Fe\", dpi=200, title=\"Fe\", clim=(0.7, maximum(Fe0)))\np3 = heatmap(distance, distance, Mn0, label=\"Mn\", dpi=200, title=\"Mn\", clim=(0, maximum(Mn0)), xlabel= \"Distance (µm)\", ylabel= \"Distance (µm)\")\np4 = heatmap(distance, distance, Ca0, label=\"Ca\", dpi=200, title=\"Ca\", clim=(0, 0.1), xlabel= \"Distance (µm)\")\n\nplot(p1, p2, p3, p4, layout = l , plot_title=\"Initial conditions\")","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"which output:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"(Image: Initial conditions 2D.)","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"Like with spherical or 1D Cartesian coordinates, we need to define our InitialConditions and Domain structure, that will hold all the information of our model.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"IC2D = InitialConditions2D(Mg0, Fe0, Mn0, Lx, Ly, tfinal; grt_boundary = grt_boundary)\ndomain2D = Domain(IC2D, T, P)","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"note: Note\nThe argument grt_boundary is a binary array specifiying the coordinates where the homogeneous Dirichlet boundaries are to be enforced, here on the contour of the grain. If not provided, the homogeneous Dirichlet boundaries are applied to the sides of the domain.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"Using the function simulate() to solve our system:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"# solve the problem using DifferentialEquations.jl\nsol = simulate(Domain2D)","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"note: Note\nThe calculation can take some time, about 6 minutes on my machine with 16 threads.","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"We can now plot the results:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"@unpack tfinal_ad, t_charact = domain2D\n\nprintln(\"Plotting...\")\nanim = @animate for i = tqdm(LinRange(0, tfinal_ad, 20))\n\n    time = round(i*t_charact;digits=2)\n\n    l = @layout [a b ; c d ]\n    Ca = 1 .- sol(i)[:,:,1] .- sol(i)[:,:,2] .- sol(i)[:,:,3]\n    replace!(Ca, 1=>0)\n\n    p1 = heatmap(distance, distance, sol(i)[:,:,1], label=\"Mg\", dpi=100, title=\"Mg\", clim=(0, maximum(sol(0)[:,:,1])), ylabel= \"Distance (µm)\")\n    p2 = heatmap(distance, distance, sol(i)[:,:,2], label=\"Fe\", dpi=100, title=\"Fe\", clim=(0.7, maximum(sol(0)[:,:,2])))\n    p3 = heatmap(distance, distance, sol(i)[:,:,3], label=\"Mn\", dpi=100, title=\"Mn\", clim=(0, maximum(sol(0)[:,:,3])), xlabel= \"Distance (µm)\", ylabel= \"Distance (µm)\")\n    p4 = heatmap(distance, distance, Ca, label=\"Ca\", dpi=100, title=\"Ca\", clim=(0, 0.1), xlabel= \"Distance (µm)\")\n\n    plot(p1, p2, p3, p4, layout = l , plot_title=\"Total Time = $(time) Ma, T=$(round(ustrip.(u\"°C\", T); digits=2)) °C\")\nend every 1\n\nprintln(\"...Done!\")\n\nprintln(\"Now, generating the gif...\")\ngif(anim, \"Grt_2D_900.gif\", fps = 3)\nprintln(\"...Done!\")\n","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"Here is the resulting gif:","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"(Image: 2D diffusion of a garnet)","category":"page"},{"location":"diffusion_2D/","page":"Diffusion in 2D Cartesian coordinates on CPU","title":"Diffusion in 2D Cartesian coordinates on CPU","text":"Note that 2D modelling ignores the effect of the third dimension on diffusion and is equivalent to considering the garnet grain to be cylindrical rather than spherical.","category":"page"},{"location":"diffusion_spherical/#sph_diffusion","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"","category":"section"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"When working with 1D profiles of major elements in garnet, it is often better to consider spherical coordinates. This approximates a garnet grain as a sphere and allows the change in volume relative to the distance from the core to be taken into account.","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"In DiffusionGarnet, spherical coordinates are as easy to use as 1D Cartesian coordinates. To illustrate this, we will compare the diffusion of a core-rim profile using the 2 coordinate systems. We will follow the same procedure as in the 1D diffusion tutorial.","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"First we will load the data of the core-rim profile from the Spherical examples section, which should be in the same folder as your current session:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"using DiffusionGarnet\nusing DelimitedFiles\n\ndata = DelimitedFiles.readdlm(\"Data_Grt_Sph.txt\", '\\t', '\\n', header=true)[1]\n\nMg0 = data[:, 4]\nFe0 = data[:, 2]\nMn0 = data[:, 3]\nCa0 = data[:, 5]\ndistance = data[:, 1]\nLx = Lr = (data[end,1] - data[1,1])u\"µm\"\ntfinal = 15u\"Myr\"","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"We can visualize our data:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"using Plots\n\nl = @layout [a ; b]\n\np1 = plot(distance, Fe0, label=\"Fe initial\", linestyle = :dash, linewidth=1, dpi=200, title = \"Initial conditions\", legend=:outerbottomright, linecolor=1,xlabel = \"Distance (µm)\", ylabel=\"Molar fraction\")\n\np2 = plot(distance, Mg0, label=\"Mg initial\", linestyle = :dash, linewidth=1, dpi=200,legend=:outerbottomright,linecolor=2,xlabel = \"Distance (µm)\")\np2 = plot!(distance, Mn0, label=\"Mn initial\", linestyle = :dash, linewidth=1, linecolor=3)\np2 = plot!(distance, Ca0, label=\"Ca initial\", linestyle = :dash, linewidth=1, linecolor=4, ylabel=\"Molar fraction\")\n\nplot(p1, p2, layout = l)","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"which output:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"(Image: Initial conditions.)","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"Then, we can define our initial conditions, both for the spherical and 1D Cartesian coordinates.","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"ICSph = InitialConditionsSpherical(Mg0, Fe0, Mn0, Lr, tfinal)\nIC1D = InitialConditions1D(Mg0, Fe0, Mn0, Lx, tfinal)\n\n# define the pressure and temperature conditions of diffusion\nT = 900u\"°C\"\nP = 0.6u\"GPa\"\n\nDomainSph = Domain(ICSph, T, P)\nDomain1D = Domain(IC1D, T, P; bc_neumann = (true, false))","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"tip: Tip\nInitialConditionsSpherical always assumes that the core of the profile is on the left and the edge is on the right side.","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"note: Note\nWe use bc_neumann in Domain to indicate that a homogeneous Neumann boundary must be ensured on the left side of the 1D profile to simulate the core of the garnet grain.","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"We can then use the function simulate() to solve our system:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"# solve the problem using DifferentialEquations.jl\nsol_sph = simulate(DomainSph)\nsol_1D = simulate(Domain1D)","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"and compare the 2 solutions:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"@unpack tfinal_ad, t_charact = DomainSph\n\nanim = @animate for i = LinRange(0, tfinal_ad, 100)\n    l = @layout [a ; b]\n\n    p1 = plot(distance, Fe0, label=\"Fe initial\", linestyle = :dash, linewidth=1, dpi=200, title = \"Total Time = $(round(((i)* t_charact);digits=2)) Ma\", legend=:outerbottomright, linecolor=1,xlabel = \"Distance (µm)\")\n    p1 = plot!(distance, sol_sph(i)[:,2], label=\"Fe Sph\",linecolor=1, linewidth=1)\n    p1 = plot!(distance, sol_1D(i)[:,2], label=\"Fe 1D\",linecolor=5, linewidth=1)\n\n\n    p2 = plot(distance, Mg0, label=\"Mg initial\", linestyle = :dash, linewidth=1, dpi=200,legend=:outerbottomright,linecolor=2,xlabel = \"Distance (µm)\")\n    p2 = plot!(distance, Mn0, label=\"Mn initial\", linestyle = :dash, linewidth=1, linecolor=3)\n    p2 = plot!(distance, Ca0, label=\"Ca initial\", linestyle = :dash, linewidth=1, linecolor=4)\n    p2 = plot!(distance, sol_sph(i)[:,1], label=\"Mg Sph\",linecolor=2, linewidth=1)\n    p2 = plot!(distance, sol_1D(i)[:,1], label=\"Mg 1D\",linecolor=6, linewidth=1)\n\n    p2 = plot!(distance, sol_sph(i)[:,3], label=\"Mn Sph\", linecolor=3, linewidth=1)\n    p2 = plot!(distance, sol_1D(i)[:,3], label=\"Mn 1D\", linecolor=7, linewidth=1)\n\n    p2 = plot!(distance, 1 .- sol_sph(i)[:,1] .- sol_sph(i)[:,2] .- sol_sph(i)[:,3], label=\"Ca Sph\", linecolor=4, linewidth=1)\n    p2 = plot!(distance, 1 .- sol_sph(i)[:,1] .- sol_sph(i)[:,2] .- sol_sph(i)[:,3], label=\"Ca 1D\", linecolor=8, linewidth=1)\n\n    plot(p1, p2, layout = l)\nend every 1\n\nprintln(\"Now, generating the gif...\")\ngif(anim, \"Grt_Spherical+1D.gif\", fps = 7)\nprintln(\"...Done!\")","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"With the resulting gif:","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"(Image: Spherical diffusion profil of a garnet)","category":"page"},{"location":"diffusion_spherical/","page":"Diffusion in spherical coordinates","title":"Diffusion in spherical coordinates","text":"It shows that using spherical coordinates makes the garnet diffuse faster. Using 1D Cartesian coordinates can overestimate the equilibration time.","category":"page"},{"location":"saving_output/#saving_output","page":"Saving output","title":"Saving output as HDF5 files","text":"","category":"section"},{"location":"updating_PT/#PT_callback","page":"Updating pressure and temperature conditions","title":"Updating pressure and temperature conditions","text":"","category":"section"},{"location":"updating_PT/","page":"Updating pressure and temperature conditions","title":"Updating pressure and temperature conditions","text":"When modelling diffusion in garnet, it may be relevant to update the pressure and temperature (PT) conditions during the simulation.","category":"page"},{"location":"updating_PT/","page":"Updating pressure and temperature conditions","title":"Updating pressure and temperature conditions","text":"To do this, we can use a callback function. A callback function is a function that can be called in our solver when a certain condition is met, i.e when a certain time is reached. It is based on the library DiffEqCallbacks from the DifferentialEquations.jl ecosystem.","category":"page"},{"location":"reference/","page":"Reference","title":"Reference","text":"","category":"page"},{"location":"reference/","page":"Reference","title":"Reference","text":"Modules  = [DiffusionGarnet]\n","category":"page"},{"location":"reference/#DiffusionGarnet.Domain","page":"Reference","title":"DiffusionGarnet.Domain","text":"Domain(IC::InitialConditions2D, T::Union{Unitful.Temperature,Array{<:Unitful.Temperature{<:Real}, 1}}, P::Union{Unitful.Pressure,Array{<:Unitful.Pressure{<:Real}, 1}}, time_update::Union{Unitful.Time,Array{<:Unitful.Time{<:Real}, 1}}=0u\"Myr\")\n\nWhen applied to 2D initial conditions, define corresponding 2D domain.\n\n\n\n\n\n","category":"type"},{"location":"reference/#DiffusionGarnet.Domain-2","page":"Reference","title":"DiffusionGarnet.Domain","text":"Domain(IC::InitialConditions1D, T::Union{Unitful.Temperature,Array{<:Unitful.Temperature{<:Real}, 1}}, P::Union{Unitful.Pressure,Array{<:Unitful.Pressure{<:Real}, 1}}, time_update::Union{Unitful.Time,Array{<:Unitful.Time{<:Real}, 1}}=0u\"Myr\"; bc_neumann::Tuple=(false, false))\n\nWhen applied to 1D initial conditions, define corresponding 1D domain. bc_neumann can be used to define Neumann boundary conditions on the left or right side of the domain if set to true.\n\n\n\n\n\n","category":"type"},{"location":"reference/#DiffusionGarnet.Domain-3","page":"Reference","title":"DiffusionGarnet.Domain","text":"Domain(IC::InitialConditionsSpherical, T::Union{Unitful.Temperature,Array{<:Unitful.Temperature{<:Real}, 1}}, P::Union{Unitful.Pressure,Array{<:Unitful.Pressure{<:Real}, 1}}, time_update::Union{Unitful.Time,Array{<:Unitful.Time{<:Real}, 1}}=0u\"Myr\")\n\nWhen applied to spherical initial conditions, define corresponding spherical domain.\n\n\n\n\n\n","category":"type"},{"location":"reference/#DiffusionGarnet.Domain-4","page":"Reference","title":"DiffusionGarnet.Domain","text":"Domain(IC, T, P, time_update=0u\"Myr\")\n\nReturn a struct containing the struct IC, the PT conditions T and P  and the nondimensionalised parameters of the problem. time_update can be used to update the PT conditions during the simulation. If so, T and P have to be of the same size as time_update and correspond to the values of PT to update to.\n\n\n\n\n\n","category":"type"},{"location":"reference/#DiffusionGarnet.Domain-5","page":"Reference","title":"DiffusionGarnet.Domain","text":"Domain(IC::InitialConditions3D, T::Union{Unitful.Temperature,Array{<:Unitful.Temperature{<:Real}, 1}}, P::Union{Unitful.Pressure,Array{<:Unitful.Pressure{<:Real}, 1}}, time_update::Union{Unitful.Time,Array{<:Unitful.Time{<:Real}, 1}}=0u\"Myr\")\n\nWhen applied to 3D initial conditions, define corresponding 3D domain.\n\n\n\n\n\n","category":"type"},{"location":"reference/#DiffusionGarnet.InitialConditions1D-Tuple{AbstractVector{<:Real}, AbstractVector{<:Real}, AbstractVector{<:Real}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐓, U}, Level{L, S, Quantity{T, 𝐓, U}} where {L, S}} where {T, U}}","page":"Reference","title":"DiffusionGarnet.InitialConditions1D","text":"InitialConditions1D(CMg0::Array{<:Real, 1}, CFe0::Array{<:Real, 1}, CMn0::Array{<:Real, 1}, Lx::Unitful.Length, tfinal::Unitful.Time)\n\nReturn a structure containing the initial conditions for a 1D diffusion problem. CMg0, CFe0 and CMn0 need to be in molar fraction. Convert the Lxandtfinal`` to µm and Myr respectively.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.InitialConditions2D-Tuple{AbstractMatrix{<:Real}, AbstractMatrix{<:Real}, AbstractMatrix{<:Real}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐓, U}, Level{L, S, Quantity{T, 𝐓, U}} where {L, S}} where {T, U}}","page":"Reference","title":"DiffusionGarnet.InitialConditions2D","text":"InitialConditions2D(CMg0::Array{<:Real, 2}, CFe0::Array{<:Real, 2}, CMn0::Array{<:Real, 2}, Lx::Unitful.Length, Ly::Unitful.Length, tfinal::Unitful.Time; grt_boundary::Array{<:Real, 2}=zeros(eltype(CMg0), size(CMg0)...))\n\nReturn a structure containing the initial conditions for a 2D diffusion problem. CMg0, CFe0 and CMn0 need to be in molar fraction. Convert Lx, Ly and tfinal to µm, µm and Myr respectively. grt_boundary is a matrix of the same size as CMg0, CFe0 and CMn0. It is a binary matrix with 1 where the contour of the garnet is present and 0 otherwise. It is used to apply the Dirichlet boundary condition in the model. If not provided, it is equal to zero everywhere.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.InitialConditions3D-Tuple{AbstractArray{<:Real, 3}, AbstractArray{<:Real, 3}, AbstractArray{<:Real, 3}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐓, U}, Level{L, S, Quantity{T, 𝐓, U}} where {L, S}} where {T, U}}","page":"Reference","title":"DiffusionGarnet.InitialConditions3D","text":"InitialConditions3D(CMg0::Array{<:Real, 3}, CFe0::Array{<:Real, 3}, CMn0::Array{<:Real, 3}, Lx::Unitful.Length, Ly::Unitful.Length, Lz::Unitful.Length, tfinal::Unitful.Time)\n\nReturn a structure containing the initial conditions for a 3D diffusion problem. CMg0, CFe0 and CMn0 need to be in molar fraction. Convert Lx, Ly, Lz and tfinal to µm, µm, µm and Myr respectively.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.InitialConditionsSpherical-Tuple{AbstractVector{<:Real}, AbstractVector{<:Real}, AbstractVector{<:Real}, Union{Quantity{T, 𝐋, U}, Level{L, S, Quantity{T, 𝐋, U}} where {L, S}} where {T, U}, Union{Quantity{T, 𝐓, U}, Level{L, S, Quantity{T, 𝐓, U}} where {L, S}} where {T, U}}","page":"Reference","title":"DiffusionGarnet.InitialConditionsSpherical","text":"InitialConditionsSpherical(CMg0::Array{<:Real, 1}, CFe0::Array{<:Real, 1}, CMn0::Array{<:Real, 1}, Lr::Unitful.Length, tfinal::Unitful.Time)\n\nReturn a structure containing the initial conditions for a spherical diffusion problem. CMg0, CFe0 and CMn0 need to be in molar fraction. Convert Lr and tfinal to µm and Myr respectively.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.simulate","page":"Reference","title":"DiffusionGarnet.simulate","text":"simulate(domain; callback=nothing, progressbar=true)\n\nSolve the coupled diffusion equation using finite differences for a given domain and return a solution type variable.\n\nThe time discretisation is based on the ROCK2 method, a stabilized explicit method (Adbdulle and Medovikov, 2001 ; https://doi.org/10.1007/s002110100292) using OrdinaryDiffEq.jl.\n\nThe solution type variable is following the format of OrdinaryDiffEq.jl (see https://docs.sciml.ai/DiffEqDocs/stable/basics/solution/), and can be used to plot the solution, and to extract the solution at a given time. As the system is nondimensionalised, the time of the solution is in nondimensional time.\n\ncallback is an optional argument, which can be used to pass a callback function to the solver. It follows the format of DiffEqCallbacks.jl (see https://docs.sciml.ai/DiffEqCallbacks/stable/).\n\nprogressbar is an optional argument, which can be used to display a progressbar during the simulation. Default is to true.\n\n\n\n\n\n","category":"function"},{"location":"reference/#DiffusionGarnet.simulate-Tuple{DiffusionGarnet.Domain1D}","page":"Reference","title":"DiffusionGarnet.simulate","text":"simulate(domain::Domain1D; callback=nothing, progressbar=true)\n\nSolve the coupled diffusion equation in 1D. Save all timesteps in the output solution type variable.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.simulate-Tuple{DiffusionGarnet.Domain2D}","page":"Reference","title":"DiffusionGarnet.simulate","text":"simulate(domain::Domain2D; callback=nothing, progressbar=true)\n\nSolve the coupled diffusion equation in 2D. Save only the first and last timestep in the output solution type variable.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.simulate-Tuple{DiffusionGarnet.DomainSpherical}","page":"Reference","title":"DiffusionGarnet.simulate","text":"simulate(domain::DomainSpherical; callback=nothing, progressbar=true)\n\nSolve the coupled diffusion equation in spherical coordinates. Save all timesteps in the output solution type variable.\n\n\n\n\n\n","category":"method"},{"location":"reference/#DiffusionGarnet.update_diffusion_coef-Tuple{Any}","page":"Reference","title":"DiffusionGarnet.update_diffusion_coef","text":"update_diffusion_coef(integrator)\n\nCallback function to update the diffusion coefficients at a given time from a new pressure and temperature. To use with the callback PresetTimeCallback (https://docs.sciml.ai/stable/basics/callbacks/#PresetTimeCallback-1).\n\nFollows the syntax of callback functions defined by DiffEqCallbacks.jl (https://docs.sciml.ai/DiffEqCallbacks/stable/).\n\n\n\n\n\n","category":"method"},{"location":"#DiffusionGarnet.jl","page":"Home","title":"DiffusionGarnet.jl","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Garnet is a mineral commonly used in metamorphic petrology to better understand geological processes, as it occurs in a variety of different rock types. This mineral often exhibits a wide range of compositional zoning, which can been interpreted as recording ranges of pressure (P) and temperature (T) conditions. Modelling diffusion processes can help to better understand this zoning and better constrain the pressure-temperature-time (PTt) conditions of the metamorphic event of interest.","category":"page"},{"location":"","page":"Home","title":"Home","text":"DiffusionGarnet is a Julia package that can be used to model the coupled diffusion of major elements on real garnet data. It currently supports 1D, spherical and 2D coordinates for evenly spaced data and will soon be extended to support 3D coordinates.","category":"page"},{"location":"#Installation","page":"Home","title":"Installation","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"DiffusionGarnet may be installed directly from the REPL:","category":"page"},{"location":"","page":"Home","title":"Home","text":"julia>]\n  pkg> add DiffusionGarnet\n  pkg> test DiffusionGarnet","category":"page"},{"location":"diffusion_1D/#1D_diffusion","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"","category":"section"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"DiffusionGarnet expects the user to provide real natural data for modelling major element diffusion in garnet. Note that the profiles must be evenly spaced. A set of example data can be found in the repository of the package in the 1D examples section for 1D profile called Data_grt_1D.txt. This is what we will use for this tutorial.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"First, we will load the data, which should be in the same folder as your current session:","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"using DiffusionGarnet  # this can take a while\nusing DelimitedFiles\n# load the data of your choice (here from the text file located in https://github.com/Iddingsite/DiffusionGarnet.jl/tree/main/examples/1D, place it in the same folder as where you are running the code)\ndata = DelimitedFiles.readdlm(\"./Data_Grt_1D.txt\", '\\t', '\\n', header=true)[1]\n\nMg0 = data[:, 4]  # load initial Mg mole fraction\nFe0 = data[:, 2]  # load initial Fe mole fraction\nMn0 = data[:, 3]  # load initial Mn mole fraction\nCa0 = data[:, 5]  # load initial Ca mole fraction\ndistance = data[:, 1]","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"We can visualize our data:","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"using Plots\n\nl = @layout [a ; b]\n\np1 = plot(distance, Fe0, label=\"Fe initial\", linestyle = :dash, linewidth=1, dpi=200, title = \"Initial conditions\", legend=:outerbottomright, linecolor=1,xlabel = \"Distance (µm)\", ylabel=\"Molar fraction\")\n\np2 = plot(distance, Mg0, label=\"Mg initial\", linestyle = :dash, linewidth=1, dpi=200,legend=:outerbottomright,linecolor=2,xlabel = \"Distance (µm)\")\np2 = plot!(distance, Mn0, label=\"Mn initial\", linestyle = :dash, linewidth=1, linecolor=3)\np2 = plot!(distance, Ca0, label=\"Ca initial\", linestyle = :dash, linewidth=1, linecolor=4, ylabel=\"Molar fraction\")\n\nplot(p1, p2, layout = l)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"which output:","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"(Image: Initial conditions.)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"Then, we will define 2 structures that DiffusionGarnet requires, which will contain all the information it needs to run a simulation.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"Lx = (data[end,1] - data[1,1])u\"µm\"  # length in x of the model, here in µm\ntfinal = 15u\"Myr\"  # total time of the model, here in Myr\n\n# define the initial conditions in 1D of your problem in that order.\nIC1D = InitialConditions1D(Mg0, Fe0, Mn0, Lx, tfinal)\n\n# define the pressure and temperature conditions of diffusion\nT = 900u\"°C\"\nP = 0.6u\"GPa\"\n\n# define a Domain struct containing the definition of our problem and nondimensionalised variables\ndomain1D = Domain(IC1D, T, P)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"note: Note\nLx, tfinal, T and P need to contain units, following the syntax of the package Unitful. This allows the user to specify the units that suit their problem.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"Domain1D contains all the information that DiffusionGarnet needs to solve our coupled diffusion problem, at 900 °C and 0.6 GPa for a duration of 15 Myr.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"This can be achieved with the function simulate():","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"# solve the problem using DifferentialEquations.jl\nsol = simulate(domain1D)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"which output the time spent on the solver, for example, on the second run:","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"  0.399870 seconds (31.93 k allocations: 18.212 MiB)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"simulate() uses the DifferentialEquations.jl package behind the hood to solve our problem efficiently. The returned variable sol is the common solution type from this package and more information can be found here. It basically holds all the information from our simulation.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"We can now plot the solution to our problem.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"# extract characteristic time to convert back to dimensional time\n@unpack tfinal_ad, t_charact = domain1D\n\nanim = @animate for i = LinRange(0, tfinal_ad, 100)\n    l = @layout [a ; b]\n\n    p1 = plot(distance, Fe0, label=\"Fe initial\", linestyle = :dash, linewidth=1, dpi=200, title = \"Timestep = $(round(((i)* t_charact);digits=2)) Ma\", legend=:outerbottomright, linecolor=1,xlabel = \"Distance (µm)\")\n    p1 = plot!(distance, sol(i)[:,2], label=\"Fe\",linecolor=1, linewidth=1)\n\n\n    p2 = plot(distance, Mg0, label=\"Mg initial\", linestyle = :dash, linewidth=1, dpi=200,legend=:outerbottomright,linecolor=2,xlabel = \"Distance (µm)\")\n    p2 = plot!(distance, Mn0, label=\"Mn initial\", linestyle = :dash, linewidth=1, linecolor=3)\n    p2 = plot!(distance, Ca0, label=\"Ca initial\", linestyle = :dash, linewidth=1, linecolor=4)\n    p2 = plot!(distance, sol(i)[:,1], label=\"Mg\",linecolor=2, linewidth=1)\n\n    p2 = plot!(distance, sol(i)[:,3], label=\"Mn\", linecolor=3, linewidth=1)\n\n    p2 = plot!(distance, 1 .- sol(i)[:,1] .- sol(i)[:,2] .- sol(i)[:,3], label=\"Ca\", linecolor=4, linewidth=1)\n\n    plot(p1, p2, layout = l)\nend every 1\n\nprintln(\"Now, generating the gif...\")\ngif(anim, \"Grt_1D_test.gif\", fps = 7)\nprintln(\"...Done!\")","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"note: Note\nTo plot the timestep, we need to dimensionalise the time back from the model, using the characteristic time t_charact defined in domain1D.","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"Here is the resulting gif obtained:","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"(Image: 1D diffusion profil of a garnet)","category":"page"},{"location":"diffusion_1D/","page":"Diffusion in 1D Cartesian coordinates","title":"Diffusion in 1D Cartesian coordinates","text":"It shows the compositional evolution of a 1D profile through a garnet grain with homogeneous Dirichlet boundaries on both sides.","category":"page"}]
}
