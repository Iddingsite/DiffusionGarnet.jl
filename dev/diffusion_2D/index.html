<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Diffusion in 2D Cartesian coordinates on CPU · DiffusionGarnet.jl</title><meta name="title" content="Diffusion in 2D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="og:title" content="Diffusion in 2D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="twitter:title" content="Diffusion in 2D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta name="description" content="Documentation for DiffusionGarnet.jl."/><meta property="og:description" content="Documentation for DiffusionGarnet.jl."/><meta property="twitter:description" content="Documentation for DiffusionGarnet.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="DiffusionGarnet.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">DiffusionGarnet.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../background/">Background</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../diffusion_1D/">Diffusion in 1D Cartesian coordinates</a></li><li><a class="tocitem" href="../diffusion_spherical/">Diffusion in spherical coordinates</a></li><li class="is-active"><a class="tocitem" href>Diffusion in 2D Cartesian coordinates on CPU</a></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Callbacks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../updating_PT/">Updating pressure and temperature conditions</a></li><li><a class="tocitem" href="../saving_output/">Saving output as HDF5 files</a></li></ul></li><li><a class="tocitem" href="../diffusion_3D_CPU/">Diffusion in 3D Cartesian coordinates on CPU</a></li><li><a class="tocitem" href="../diffusion_3D_GPU/">Diffusion in 3D Cartesian coordinates on GPU</a></li></ul></li><li><a class="tocitem" href="../reference/">List of functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Diffusion in 2D Cartesian coordinates on CPU</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Diffusion in 2D Cartesian coordinates on CPU</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl/blob/main/docs/src/diffusion_2D.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="2D_diffusion_CPU"><a class="docs-heading-anchor" href="#2D_diffusion_CPU">Diffusion in 2D Cartesian coordinates on CPU</a><a id="2D_diffusion_CPU-1"></a><a class="docs-heading-anchor-permalink" href="#2D_diffusion_CPU" title="Permalink"></a></h1><p>From chemical maps (e.g. obtained by microprobe or SEM), we can acquire 2D composition of garnet. Assuming an initial composition, we can diffuse a garnet grain major element composition.</p><p>When dealing with 2D or 3D data, the question of performance comes into play. It is important to write performant code that scales well. To help us with this, DiffusionGarnet internally uses the package <a href="https://github.com/omlins/ParallelStencil.jl">ParallelStencil.jl</a>, which allows to write high-level code for parallel high-performance stencil computation on both GPUs and CPUs. We will focus on CPUs in this tutorial, as they are easier to set up, but significant performance gains can be expected on GPUs.</p><p>To get the most out of this approach, it is important to start Julia with multiple threads as multithreading is the approach used to parallelise the code. See the <a href="https://docs.julialang.org/en/v1/manual/multi-threading/">official Julia documentation</a> for more information.</p><p>To achieve this, the simpler is to start Julia with:</p><pre><code class="nohighlight hljs">$ julia --threads auto</code></pre><p>which should select the maximum number of threads available on your machine.</p><p>The check that, we can use:</p><pre><code class="language-julia-repl hljs">julia&gt; println(&quot;Number of threads: $(Base.Threads.nthreads())&quot;)
16</code></pre><p>which outputs the current number of threads used in the Julia session (here 16).</p><div class="admonition is-success" id="Tip-f8aaf9b3953390c4"><header class="admonition-header">Tip<a class="admonition-anchor" href="#Tip-f8aaf9b3953390c4" title="Permalink"></a></header><div class="admonition-body"><p>The degree of parallelisation that can be achieved increases with the number of threads available.</p></div></div><p>For this tutorial, we will use example data from the <a href="https://github.com/Iddingsite/DiffusionGarnet.jl/tree/main/examples/2D">2D examples section</a>, which contain four composition matrices, and the contour of the garnet grain.</p><p>First, we load the data, which should be in the same folder as your current session:</p><pre><code class="language-julia hljs">using DiffusionGarnet  # this can take a while
using DelimitedFiles
using Plots
using ProgressBars
using Printf

println(&quot;Number of threads: $(Threads.nthreads())&quot;)

# load the data of your choice
# (here from the text files located in https://github.com/Iddingsite/DiffusionGarnet.jl/tree/main/examples/2D,
# place it in the same folder as where you are running the code)

Mg0 = DelimitedFiles.readdlm(&quot;Xprp.txt&quot;, &#39;\t&#39;, &#39;\n&#39;, header=false)
Fe0 = DelimitedFiles.readdlm(&quot;Xalm.txt&quot;, &#39;\t&#39;, &#39;\n&#39;, header=false)
Mn0 = DelimitedFiles.readdlm(&quot;Xsps.txt&quot;, &#39;\t&#39;, &#39;\n&#39;, header=false)
Ca0 = DelimitedFiles.readdlm(&quot;Xgrs.txt&quot;, &#39;\t&#39;, &#39;\n&#39;, header=false)
grt_boundary = DelimitedFiles.readdlm(&quot;contour_Grt.txt&quot;, &#39;\t&#39;, &#39;\n&#39;, header=false)

# define total length in x and y
Lx = 9000.0u&quot;µm&quot;
Ly = 9000.0u&quot;µm&quot;
# define total time for the model
tfinal = 1.0u&quot;Myr&quot;
# define the pressure and temperature conditions
T = 900u&quot;°C&quot;
P = 0.6u&quot;GPa&quot;</code></pre><p>Plotting the initial data:</p><pre><code class="language-julia hljs">distance = LinRange(0, ustrip(u&quot;µm&quot;, Lx), size(Mg0,1))

l = @layout [a b ; c d ]

p1 = heatmap(distance, distance, Mg0, label=&quot;Mg&quot;, dpi=200, title=&quot;Mg&quot;, clim=(0, maximum(Mg0)), ylabel= &quot;Distance (µm)&quot;)
p2 = heatmap(distance, distance, Fe0, label=&quot;Fe&quot;, dpi=200, title=&quot;Fe&quot;, clim=(0.7, maximum(Fe0)))
p3 = heatmap(distance, distance, Mn0, label=&quot;Mn&quot;, dpi=200, title=&quot;Mn&quot;, clim=(0, maximum(Mn0)), xlabel= &quot;Distance (µm)&quot;, ylabel= &quot;Distance (µm)&quot;)
p4 = heatmap(distance, distance, Ca0, label=&quot;Ca&quot;, dpi=200, title=&quot;Ca&quot;, clim=(0, 0.1), xlabel= &quot;Distance (µm)&quot;)

plot(p1, p2, p3, p4, layout = l , plot_title=&quot;Initial conditions&quot;)</code></pre><p>which outputs:</p><p><img src="../assets/img/2D_IC.png" alt="Initial conditions 2D."/></p><p>Like with <a href="../diffusion_spherical/#sph_diffusion">spherical</a> or <a href="../diffusion_1D/#1D_diffusion">1D Cartesian</a> coordinates, we need to define our <code>InitialConditions</code> and <code>Domain</code> structures, that will hold all the information of our model.</p><pre><code class="language-julia hljs">IC2D = IC2DMajor(;CMg0=Mg0, CFe0=Fe0, CMn0=Mn0, Lx, Ly, tfinal, grt_boundary)
domain2D = Domain(IC2D, T, P)</code></pre><div class="admonition is-info" id="Note-e85c6f6916bf4aaf"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-e85c6f6916bf4aaf" title="Permalink"></a></header><div class="admonition-body"><p>The argument <code>grt_boundary</code> is a binary array specifiying the coordinates where the homogeneous Dirichlet boundaries are to be enforced, here on the contour of the grain. If not provided, the homogeneous Dirichlet boundaries are applied to the sides of the domain.</p></div></div><p>Using the function <code>simulate()</code> to solve our system:</p><pre><code class="language-julia hljs"># solve the problem using DifferentialEquations.jl
sol = simulate(Domain2D, progress=true, progress_steps=1)</code></pre><p>We use here the arguments <code>progress=true</code> and <code>progress_steps=1</code> to display a progress bar during the calculation.</p><div class="admonition is-info" id="Note-db447cfb9a3e5252"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-db447cfb9a3e5252" title="Permalink"></a></header><div class="admonition-body"><p>The calculation can take some time, about 6 minutes on my machine with 16 threads.</p></div></div><p>We can now plot the results:</p><pre><code class="language-julia hljs">@unpack t_charact = domain2D

println(&quot;Plotting...&quot;)
anim = @animate for i = tqdm(LinRange(0, sol.t[end], 20))

    time = round(i*t_charact;digits=2)

    l = @layout [a b ; c d ]
    Ca = 1 .- sol(i)[:,:,1] .- sol(i)[:,:,2] .- sol(i)[:,:,3]
    replace!(Ca, 1=&gt;0)

    p1 = heatmap(distance, distance, sol(i)[:,:,1], label=&quot;Mg&quot;, dpi=100, title=&quot;Mg&quot;, clim=(0, maximum(sol(0)[:,:,1])), ylabel= &quot;Distance (µm)&quot;)
    p2 = heatmap(distance, distance, sol(i)[:,:,2], label=&quot;Fe&quot;, dpi=100, title=&quot;Fe&quot;, clim=(0.7, maximum(sol(0)[:,:,2])))
    p3 = heatmap(distance, distance, sol(i)[:,:,3], label=&quot;Mn&quot;, dpi=100, title=&quot;Mn&quot;, clim=(0, maximum(sol(0)[:,:,3])), xlabel= &quot;Distance (µm)&quot;, ylabel= &quot;Distance (µm)&quot;)
    p4 = heatmap(distance, distance, Ca, label=&quot;Ca&quot;, dpi=100, title=&quot;Ca&quot;, clim=(0, 0.1), xlabel= &quot;Distance (µm)&quot;)

    plot(p1, p2, p3, p4, layout = l , plot_title=@sprintf(&quot;Total Time = %.2f Ma | T = %.0f °C | P = %.1f GPa&quot;, i*t_charact, T[1].val, P[1].val), plot_titlefontsize=12)
end every 1

println(&quot;...Done!&quot;)

println(&quot;Now, generating the gif...&quot;)
gif(anim, &quot;Grt_2D_900.gif&quot;, fps = 3)
println(&quot;...Done!&quot;)
</code></pre><p>Here is the resulting gif:</p><p><img src="../assets/img/Grt_2D.gif" alt="2D diffusion of a garnet"/></p><div class="admonition is-info" id="Note-156bde2cc1c4562d"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-156bde2cc1c4562d" title="Permalink"></a></header><div class="admonition-body"><p>2D modelling ignores the effect of the third dimension on diffusion and is equivalent to considering the garnet grain to be cylindrical rather than spherical.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../diffusion_spherical/">« Diffusion in spherical coordinates</a><a class="docs-footer-nextpage" href="../updating_PT/">Updating pressure and temperature conditions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Monday 4 August 2025 22:02">Monday 4 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
