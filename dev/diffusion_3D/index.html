<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl</title><meta name="title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="og:title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta property="twitter:title" content="Diffusion in 3D Cartesian coordinates on CPU · DiffusionGarnet.jl"/><meta name="description" content="Documentation for DiffusionGarnet.jl."/><meta property="og:description" content="Documentation for DiffusionGarnet.jl."/><meta property="twitter:description" content="Documentation for DiffusionGarnet.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="DiffusionGarnet.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">DiffusionGarnet.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../background/">Background</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../diffusion_1D/">Diffusion in 1D Cartesian coordinates</a></li><li><a class="tocitem" href="../diffusion_spherical/">Diffusion in spherical coordinates</a></li><li><a class="tocitem" href="../diffusion_2D/">Diffusion in 2D Cartesian coordinates on CPU</a></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Callbacks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../updating_PT/">Updating pressure and temperature conditions</a></li><li><a class="tocitem" href="../saving_output/">Saving output as HDF5 files</a></li></ul></li><li class="is-active"><a class="tocitem" href>Diffusion in 3D Cartesian coordinates on CPU</a></li></ul></li><li><a class="tocitem" href="../reference/">List of functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Diffusion in 3D Cartesian coordinates on CPU</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Diffusion in 3D Cartesian coordinates on CPU</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Iddingsite/DiffusionGarnet.jl/blob/main/docs/src/diffusion_3D.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="3D_diffusion_CPU"><a class="docs-heading-anchor" href="#3D_diffusion_CPU">Diffusion in 3D Cartesian coordinates on CPU</a><a id="3D_diffusion_CPU-1"></a><a class="docs-heading-anchor-permalink" href="#3D_diffusion_CPU" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This tutorial is combining the knowledge acquired from the <a href="../diffusion_2D/#2D_diffusion_CPU">2D modelling</a> and the <a href="../saving_output/#saving_output">Saving output as HDF5 files</a> tutorials. Make sure to understand them before starting this one.</p></div></div><p>The 3D geometry of garnets can be obtained from computed tomography (CT) scans or other similar techniques. Combined with an initial composition, the full grain can be modelled with realistic geometry.</p><p>In this tutorial, we will use fake geometry data and fake composition data with a low resolution to get a reasonable runtime. The acquisition and processing of original data is beyond the scope of this tutorial and this package, and is left to the user. The goal of this tutorial is only to illustrate the use of DiffusionGarnet.jl in 3D Cartesian coordinates and show how to visualise the results.</p><p>To do so, we will use a callback function to save the results of the simulation to disk at regular intervals to be able to visualize the results using the software <a href="https://www.paraview.org/">Paraview</a>.</p><p>As mentioned in the tutorial for <a href="../diffusion_2D/#2D_diffusion_CPU">2D modelling</a> DiffusionGarnet internally uses the package <a href="https://github.com/omlins/ParallelStencil.jl">ParallelStencil.jl</a>. Make sure to start with multiple threads to get the most out of this approach if you run the model on CPU.</p><p>For this tutorial, we will use example data from the <a href="https://github.com/Iddingsite/DiffusionGarnet.jl/tree/main/examples/3D">3D examples section</a>, which contains four composition matrices, and the contour of a fake spherical grain. The total resolution is of 128x128x128 voxels.</p><p>First, we load the data, which should be in the same folder as your current session:</p><pre><code class="language-julia hljs">using DiffusionGarnet  # this can take a while
using JLD2
using Plots

println(&quot;Number of threads: $(Threads.nthreads())&quot;)
# should ideally output more than 1 thread

# use JLD2 to load data
file = jldopen(&quot;3D_data.jld2&quot;, &quot;r&quot;)
@unpack Mg0, Fe0, Mn0, Ca0, grt_boundary = file
close(file)</code></pre><p>We will use the same conditions as in the <a href="../diffusion_2D/#2D_diffusion_CPU">2D modelling tutorial</a>:</p><pre><code class="language-julia hljs"># define total length in x and y
Lx = 9000.0u&quot;µm&quot;
Ly = 9000.0u&quot;µm&quot;
Lz = 9000.0u&quot;µm&quot;
# define total time for the model
tfinal = 1.0u&quot;Myr&quot;
# define the pressure and temperature conditions
T = 900u&quot;°C&quot;
P = 0.6u&quot;GPa&quot;

IC3D = InitialConditions3D(Mg0, Fe0, Mn0, Lx, Ly, Lz, tfinal; grt_boundary = grt_boundary)
domain3D = Domain(IC3D, T, P)</code></pre><p>Now, let&#39;s define a callback function to save the results of the simulation in a HDF5 file, similar to the tutorial <a href="../saving_output/#saving_output">Saving output as HDF5 files</a>:</p><pre><code class="language-julia hljs">@unpack t_charact = domain3D  # unpack characteristic time to nondimensionalise the time for the simulation
time_save_ad = ustrip.(u&quot;Myr&quot;, time_save) ./ t_charact  # convert to Myr, remove units, and convert to nondimensional time

save_data_callback = PresetTimeCallback(time_save_ad, save_data_paraview)

path_save = &quot;Grt_3D.h5&quot;  # choose the name and the path of the HDF5 output file (make sure to add .h5 or .hdf5 at the end)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We used here <code>save_data_paraview()</code> instead of <code>save_data()</code> to save the data in a format that can be read by Paraview.</p></div></div><p>We can now use the function <code>simulate()</code> to solve our system:</p><pre><code class="language-julia hljs"># solve the problem using DifferentialEquations.jl
sol = simulate(Domain3D; callback=save_data_callback, path_save=path_save, save_everystep=false, progress=true, progress_steps=1)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The calculation can take some time, about 4 minutes on my machine with 16 threads.</p></div></div><p>Two files should have been created in the same folder as your current session: <code>Grt_3D.h5</code> and <code>Grt_3D.xdmf</code>. The first one is the HDF5 file containing the results of the simulation, and the second one is an XDMF file describing the HDF5 file. This last file can be opened with visualisation software programs, such as <a href="https://www.paraview.org/">Paraview</a>.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>For any visualisation software, make sure you open the XDMF file and not the HDF5 file. For <a href="https://www.paraview.org/">Paraview</a>, select the <code>XDMF Reader</code> as the reader when you open your data. Only Paraview has been tested with this package, but other software should work as well.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../saving_output/">« Saving output as HDF5 files</a><a class="docs-footer-nextpage" href="../reference/">List of functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 1 February 2024 13:10">Thursday 1 February 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
